#!/usr/bin/env bash
set -euo pipefail

if [ "$(id -u)" -ne 0 ]; then
  echo "Bitte als root ausfuehren."
  exit 1
fi

echo "Dieses Script installiert AufsichtsHelper als systemd Service."
echo

prompt() {
  local var_name="$1"
  local prompt_text="$2"
  local default_value="$3"
  local input=""
  read -r -p "${prompt_text} [${default_value}]: " input
  if [ -z "$input" ]; then
    input="$default_value"
  fi
  printf -v "$var_name" "%s" "$input"
}

prompt APP_DIR "Installationsverzeichnis" "/opt/aufsichtshelper"
prompt APP_USER "Linux-User" "aufsichtshelper"
prompt SERVICE_NAME "Service-Name" "aufsichtshelper"
prompt APP_HOST "Host" "0.0.0.0"
prompt APP_PORT "Port" "5000"

APP_PY="$APP_DIR/.venv/bin/python"
if [ ! -x "$APP_PY" ]; then
  echo "Kein venv gefunden. Bitte zuerst setupAufsichtsHelper ausfuehren."
  exit 1
fi

SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=AufsichtsHelper Flask App
After=network.target

[Service]
Type=simple
User=${APP_USER}
Group=${APP_USER}
WorkingDirectory=${APP_DIR}
Environment=PYTHONUNBUFFERED=1
EnvironmentFile=-${APP_DIR}/.env
ExecStart=${APP_PY} -m flask --app run.py run --host ${APP_HOST} --port ${APP_PORT}
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

echo
echo "Service installiert. Status:"
systemctl status --no-pager "$SERVICE_NAME"
