{% extends 'base.html' %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Vorschau</h1>
    <span class="badge bg-secondary">Gesamt: {{ total_rows }}</span>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-6">
      <label class="form-label">Aufsicht ({{ aufsicht_names | length }})</label>
      <select class="form-select" name="aufsicht" required>
        {% for name in aufsicht_names %}
          <option value="{{ name }}" {% if name == selected_aufsicht %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-primary" type="submit">Filtern</button>
    </div>
  </form>

  <div class="mb-3 text-muted">
    Es wurden {{ filtered_count }} Pruefungen fuer die Aufsicht {{ selected_aufsicht }} gefunden.
  </div>

  {% if missing_contacts %}
    <div class="alert alert-warning">
      <strong>Fehlende Stammdaten oder E-Mail:</strong>
      <ul class="mb-0">
        {% for item in missing_contacts %}
          <li>{{ item.name }} - {{ item.reason }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-body">
      <form method="post" action="{{ url_for('main.send') }}">
        <input type="hidden" name="aufsicht" value="{{ selected_aufsicht }}">
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="force_resend" value="1" id="forceResend">
          <label class="form-check-label" for="forceResend">Neu erstellen (Force resend)</label>
        </div>
        <button class="btn btn-success" type="submit" {% if not filter_applied %}disabled aria-disabled="true"{% endif %}>
          ICS-Paket erstellen
        </button>
        {% if not filter_applied %}
          <div class="form-text">Bitte zuerst filtern, dann kann das ICS-Paket erstellt werden.</div>
        {% endif %}
      </form>
    </div>
  </div>

  {% if preview_rows %}
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            {% for col in expected_columns %}
              <th>
                <div class="d-flex align-items-center gap-2">
                  <span>{{ col }}</span>
                  {% if col in sortable_columns %}
                    {% set asc_active = sort_key == col and sort_dir == 'asc' %}
                    {% set desc_active = sort_key == col and sort_dir == 'desc' %}
                    <div class="sort-arrows" role="group">
                      <a
                        class="sort-arrow up {% if asc_active %}is-active{% endif %}"
                        href="{{ url_for('main.preview', aufsicht=selected_aufsicht, sort=col, dir='asc') }}"
                        aria-label="Aufsteigend"
                        title="Aufsteigend"
                      ></a>
                      <a
                        class="sort-arrow down {% if desc_active %}is-active{% endif %}"
                        href="{{ url_for('main.preview', aufsicht=selected_aufsicht, sort=col, dir='desc') }}"
                        aria-label="Absteigend"
                        title="Absteigend"
                      ></a>
                    </div>
                  {% endif %}
                </div>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in preview_rows %}
            <tr>
              {% for col in expected_columns %}
                <td>
                  {% if col in multiline_columns %}
                    {% set items = row[col] %}
                    {% if items %}
                      {% for item in items %}
                        {{ item }}{% if not loop.last %}<br>{% endif %}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    {{ row[col] }}
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">Keine Zeilen gefunden.</div>
  {% endif %}
{% endblock %}

